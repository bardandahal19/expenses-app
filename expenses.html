<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Daily Expense Tracker</title>
  <style>
    body { font-family: system-ui, -apple-system, Arial, sans-serif; margin: 16px; max-width: 820px; }
    h1 { margin: 0 0 10px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; margin: 12px 0; }
    label { display:block; font-size: 13px; margin: 10px 0 6px; color:#333; }
    input, select, button, textarea {
      width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #ccc; font-size: 16px;
    }
    textarea { min-height: 60px; resize: vertical; }
    .row { display:flex; gap: 10px; flex-wrap: wrap; }
    .row > div { flex: 1 1 180px; }
    button { cursor:pointer; border: none; background: #111; color: #fff; }
    button.secondary { background:#eee; color:#111; border:1px solid #ccc; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align:left; padding: 10px; border-bottom: 1px solid #eee; font-size: 14px; }
    .muted { color:#666; font-size: 13px; }
    .pill { display:inline-block; padding: 3px 8px; border-radius: 999px; background:#f3f3f3; font-size: 12px; }
    .danger { color:#b00020; }
    .totals { display:flex; gap: 12px; flex-wrap: wrap; }
    .totals .box { flex: 1 1 160px; border:1px solid #eee; border-radius: 12px; padding: 10px; }
    .big { font-size: 20px; font-weight: 700; }
  </style>
</head>
<body>
  <h1>Daily Expense Tracker</h1>
  <div class="muted">Runs offline. Data saved in your browser (localStorage).</div>

  <div class="card">
    <h2 style="margin:0 0 6px;">Add expense</h2>

    <div class="row">
      <div>
        <label>Date</label>
        <input id="date" type="date" />
      </div>
      <div>
        <label>Amount (CAD)</label>
        <input id="amount" type="number" step="0.01" min="0" placeholder="e.g., 12.50" />
      </div>
      <div>
        <label>Category</label>
        <select id="category">
          <option>Food</option>
          <option>Transport</option>
          <option>Bills</option>
          <option>Credit Card</option>
          <option>Loan</option>
          <option>Investing (TFSA)</option>
          <option>Cricket</option>
          <option>Shopping</option>
          <option>Other</option>
        </select>
      </div>
    </div>

    <label>Description (optional)</label>
    <textarea id="note" placeholder="e.g., Uber to work, lunch, etc."></textarea>

    <div class="row" style="margin-top:10px;">
      <div><button id="addBtn">Add</button></div>
      <div><button class="secondary" id="clearAllBtn" title="Deletes ALL records">Clear all</button></div>
      <div><button class="secondary" id="exportBtn">Export CSV</button></div>
    </div>

    <div id="msg" class="muted" style="margin-top:8px;"></div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 10px;">Summary</h2>
    <div class="row">
      <div>
        <label>Filter range</label>
        <select id="range">
          <option value="today">Today</option>
          <option value="week">Last 7 days</option>
          <option value="month">This month</option>
          <option value="all">All time</option>
        </select>
      </div>
      <div>
        <label>Category filter</label>
        <select id="catFilter">
          <option value="all">All categories</option>
        </select>
      </div>
      <div>
        <label>Search</label>
        <input id="search" type="text" placeholder="search description..." />
      </div>
    </div>

    <div class="totals" style="margin-top:12px;">
      <div class="box">
        <div class="muted">Total (filtered)</div>
        <div id="totalFiltered" class="big">$0.00</div>
      </div>
      <div class="box">
        <div class="muted">Total today</div>
        <div id="totalToday" class="big">$0.00</div>
      </div>
      <div class="box">
        <div class="muted">Total this month</div>
        <div id="totalMonth" class="big">$0.00</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 10px;">Expenses</h2>
    <div class="muted">Tap “Delete” to remove one entry.</div>
    <div style="overflow:auto; margin-top:8px;">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Category</th>
            <th>Description</th>
            <th>Amount</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

<script>
  const KEY = "expense_tracker_v1";

  const el = (id) => document.getElementById(id);
  const dateEl = el("date");
  const amountEl = el("amount");
  const categoryEl = el("category");
  const noteEl = el("note");
  const msgEl = el("msg");

  const rangeEl = el("range");
  const catFilterEl = el("catFilter");
  const searchEl = el("search");

  const totalFilteredEl = el("totalFiltered");
  const totalTodayEl = el("totalToday");
  const totalMonthEl = el("totalMonth");
  const tableBody = el("tableBody");

  function todayISO() {
    const d = new Date();
    const tzOffset = d.getTimezoneOffset() * 60000;
    return new Date(Date.now() - tzOffset).toISOString().slice(0, 10);
  }

  dateEl.value = todayISO();

  function load() {
    try {
      return JSON.parse(localStorage.getItem(KEY)) || [];
    } catch {
      return [];
    }
  }

  function save(items) {
    localStorage.setItem(KEY, JSON.stringify(items));
  }

  function money(n) {
    return "$" + Number(n).toFixed(2);
  }

  function startOfMonthISO(dISO) {
    return dISO.slice(0, 7) + "-01";
  }

  function inRange(itemDateISO, range) {
    const d = new Date(itemDateISO + "T00:00:00");
    const now = new Date(todayISO() + "T00:00:00");

    if (range === "all") return true;
    if (range === "today") return itemDateISO === todayISO();

    if (range === "week") {
      const diffDays = Math.floor((now - d) / (1000 * 60 * 60 * 24));
      return diffDays >= 0 && diffDays <= 6;
    }

    if (range === "month") {
      return itemDateISO >= startOfMonthISO(todayISO()) && itemDateISO <= todayISO();
    }
    return true;
  }

  function rebuildCategoryFilter(items) {
    const cats = Array.from(new Set(items.map(x => x.category))).sort();
    const current = catFilterEl.value || "all";
    catFilterEl.innerHTML = `<option value="all">All categories</option>` +
      cats.map(c => `<option value="${c}">${c}</option>`).join("");
    if ([...catFilterEl.options].some(o => o.value === current)) {
      catFilterEl.value = current;
    }
  }

  function getFiltered(items) {
    const range = rangeEl.value;
    const cat = catFilterEl.value;
    const q = (searchEl.value || "").trim().toLowerCase();

    return items
      .filter(x => inRange(x.date, range))
      .filter(x => (cat === "all" ? true : x.category === cat))
      .filter(x => (q ? (x.note || "").toLowerCase().includes(q) : true))
      .sort((a,b) => (b.date.localeCompare(a.date) || b.createdAt - a.createdAt));
  }

  function render() {
    const items = load();
    rebuildCategoryFilter(items);

    // totals
    const totalToday = items.filter(x => x.date === todayISO())
                           .reduce((s,x) => s + x.amount, 0);
    const totalMonth = items.filter(x => x.date >= startOfMonthISO(todayISO()) && x.date <= todayISO())
                            .reduce((s,x) => s + x.amount, 0);

    totalTodayEl.textContent = money(totalToday);
    totalMonthEl.textContent = money(totalMonth);

    const filtered = getFiltered(items);
    const totalFiltered = filtered.reduce((s,x) => s + x.amount, 0);
    totalFilteredEl.textContent = money(totalFiltered);

    // table
    tableBody.innerHTML = filtered.map(x => `
      <tr>
        <td>${x.date}</td>
        <td><span class="pill">${x.category}</span></td>
        <td>${(x.note || "").replaceAll("<","&lt;").replaceAll(">","&gt;")}</td>
        <td><b>${money(x.amount)}</b></td>
        <td><button class="secondary" data-id="${x.id}">Delete</button></td>
      </tr>
    `).join("");

    tableBody.querySelectorAll("button[data-id]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-id");
        const updated = load().filter(x => x.id !== id);
        save(updated);
        render();
      });
    });
  }

  el("addBtn").addEventListener("click", () => {
    const date = dateEl.value;
    const amount = Number(amountEl.value);
    const category = categoryEl.value;
    const note = noteEl.value.trim();

    if (!date) return (msgEl.textContent = "Pick a date.");
    if (!Number.isFinite(amount) || amount <= 0) return (msgEl.textContent = "Enter a valid amount (> 0).");

    const items = load();
    items.push({
      id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2),
      date,
      amount,
      category,
      note,
      createdAt: Date.now()
    });
    save(items);

    amountEl.value = "";
    noteEl.value = "";
    msgEl.textContent = "Added ✅";
    setTimeout(() => msgEl.textContent = "", 1200);

    render();
  });

  el("clearAllBtn").addEventListener("click", () => {
    const ok = confirm("This will delete ALL entries. Are you sure?");
    if (!ok) return;
    localStorage.removeItem(KEY);
    render();
  });

  el("exportBtn").addEventListener("click", () => {
    const items = load().sort((a,b) => a.date.localeCompare(b.date));
    const header = ["date","category","amount","description"];
    const rows = items.map(x => [
      x.date,
      x.category,
      x.amount.toFixed(2),
      (x.note || "").replaceAll('"','""')
    ]);

    const csv = [header, ...rows].map(r => r.map(v => `"${v}"`).join(",")).join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "expenses.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  [rangeEl, catFilterEl, searchEl].forEach(x => x.addEventListener("input", render));

  render();
</script>
</body>
</html>
